<!DOCTYPE html>
<html lang="en">
<head>
    <title>dc.js - Filtering Example</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="../css/dc.css"/>
</head>
<body>

<!--   <div id="chart-ring-year" style="width:300px; height:300px">
    <div class="reset" style="visibility: hidden;">selected: <span class="filter"></span>
      <a href="javascript:yearRingChart.filterAll();dc.redrawAll();">reset</a>
    </div>
  </div> -->
  <div id="chart-line" style="width:300px; height:300px">
  </div>
  <div id="timeline" style="width:300px; height:300px">
  </div>
<!--   <div id="chart-hist-spend" style="width:300px; height:300px">
    <div class="reset" style="visibility: hidden;">range: <span class="filter"></span>
      <a href="javascript:spendHistChart.filterAll();dc.redrawAll();">reset</a>
    </div>
  </div>
  <div id="chart-row-spenders">
    <div class="reset" style="visibility: hidden;">selected: <span class="filter"></span>
      <a href="javascript:spenderRowChart.filterAll();dc.redrawAll();">reset</a>
    </div>
  </div> -->

<script type="text/javascript" src="../js/d3.js"></script>
<script type="text/javascript" src="../js/crossfilter.js"></script>
<script type="text/javascript" src="../js/dc.js"></script>
<script type="text/javascript">
// var yearRingChart   = dc.pieChart("#chart-ring-year"),
//     spendHistChart  = dc.barChart("#chart-hist-spend"),
    var lineChart  = dc.lineChart("#chart-line");
    var timeChart  = dc.barChart("#timeline");
    // spenderRowChart = dc.rowChart("#chart-row-spenders");
// use static or load via d3.csv("spendData.csv", function(error, spendData) {/* do stuff */});
var spendData = [
    {Name: 'Mr A', Spent: '$40', Year: 2011},
    {Name: 'Mr B', Spent: '$10', Year: 2011},
    {Name: 'Mr C', Spent: '$40', Year: 2011},
    {Name: 'Mr A', Spent: '$70', Year: 2012},
    {Name: 'Mr B', Spent: '$20', Year: 2012},
    {Name: 'Mr B', Spent: '$50', Year: 2013},
    {Name: 'Mr C', Spent: '$30', Year: 2013}
];

var ewhData = [
    {"_id":"56e9ad499f57ee68386e4ecf","temperature":78,"turbidity":4,"conductivity":7,"pH":8,"usage":23,"__v":0,"timestamp":"2015-11-11T05:00:00.000Z"},
    {"_id":"56e9ad499f57ee68386e4ed0","temperature":54,"turbidity":9,"conductivity":4,"pH":6,"usage":25,"__v":0,"timestamp":"2015-11-12T05:00:00.000Z"},
    {"_id":"56e9ad499f57ee68386e4ed1","temperature":85,"turbidity":7,"conductivity":5,"pH":8,"usage":7,"__v":0,"timestamp":"2015-11-13T05:00:00.000Z"},
    {"_id":"56e9ad499f57ee68386e4ed2","temperature":54,"turbidity":9,"conductivity":4,"pH":6,"usage":9,"__v":0,"timestamp":"2015-11-14T05:00:00.000Z"},
    {"_id":"56e9ad499f57ee68386e4ed3","temperature":92,"turbidity":5,"conductivity":5,"pH":7,"usage":32,"__v":0,"timestamp":"2015-11-15T05:00:00.000Z"},
    {"_id":"56e9ad499f57ee68386e4ed4","temperature":37,"turbidity":7,"conductivity":5,"pH":4,"usage":10,"__v":0,"timestamp":"2015-11-16T05:00:00.000Z"}
    ];
var ewhData1 = [
    {"conductivity":[1,2,3]},
    {"conductivity":[2,3,4]},
    {"conductivity":[3,4,5]},
    {"conductivity":[4,5,6]},
    ];

// Circle chart, graphs each different value given by dimension as a new sector

// normalize/parse data
spendData.forEach(function(d) {
    d.Spent = d.Spent.match(/\d+/);
});
// set crossfilter
var ndx = crossfilter(spendData),
    yearDim  = ndx.dimension(function(d) {return +d.Year;}),
    spendDim = ndx.dimension(function(d) {return Math.floor(d.Spent/10);}),
    nameDim  = ndx.dimension(function(d) {return d.Name;}),
    spendPerYear = yearDim.group().reduceSum(function(d) {return +d.Spent;}),
    spendPerName = nameDim.group().reduceSum(function(d) {return +d.Spent;}),
    spendHist    = spendDim.group().reduceCount();


var parser = d3.time.format("%Y-%m-%dT%H:%M:%S.000Z");
ewhData.forEach(function(d) {
    d.timestamp = parser.parse(d.timestamp);
});


var ndx2 = crossfilter(ewhData),
    dateDim = ndx2.dimension(function (d) { return d.timestamp; }),
    usage = dateDim.group().reduceSum(function (d) { return +d.usage; }); 
    pH = dateDim.group().reduceSum(function (d) { return +d.pH; }); 
var minDate = dateDim.bottom(1)[0].timestamp;
var maxDate = dateDim.top(1)[0].timestamp;

lineChart
    .dimension(dateDim)
    .group(usage)
    .x(d3.time.scale().domain([minDate, maxDate]))
    .rangeChart(timeChart)
    .elasticY(true)
    .brushOn(false)
timeChart
    .dimension(dateDim)
    .group(pH)
    .brushOn(true)
    .x(d3.time.scale().domain([minDate, maxDate]))

// yearRingChart
//     .width(768)
//     .height(480)
//     .x(d3.time.scale().domain([minDate, maxDate]))
//     .dimension(dateDim)
//     .group(usage)
    // .innerRadius(50);
    // .controlsUseVisibility(true);
// yearRingChart
//     .dimension(yearDim)
//     .group(spendPerYear)
//     .innerRadius(50)
    // .title(function(d){
    //   return d.Spent
    //   + "\nNumber of Events: " + d.Spent;
    //   });

// spendHistChart
//     .dimension(spendDim)
//     .group(spendHist)
//     .x(d3.scale.linear().domain([0,10]))
//     .elasticY(true);
//     // .controlsUseVisibility(true);
// spendHistChart.xAxis().tickFormat(function(d) {return d*10}); // convert back to base unit
// spendHistChart.yAxis().ticks(2);
// spenderRowChart
//     .dimension(nameDim)
//     .group(spendPerName)
//     .elasticX(true);
    //.controlsUseVisibility(true);
dc.renderAll();
</script>

</body>
</html>